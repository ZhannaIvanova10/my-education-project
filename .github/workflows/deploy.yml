name: CI/CD Pipeline

on:
  push:
    branches: [ homework/cicd-deploy, develop, main ]
  pull_request:
    branches: [ develop ]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Install dependencies
      run: |
        cd backend
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests
      run: |
        cd backend
        python manage.py test
      continue-on-error: false  # Останавливаем при ошибке

    - name: Test failure notification
      if: failure()
      run: echo "❌ Тесты не прошли! Деплой отменен."

  deploy:
    needs: tests
    runs-on: ubuntu-latest
    if: success()  # Запускаем только если тесты прошли

    steps:
    - uses: actions/checkout@v3

    - name: Install SSH key
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to server
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USER }}
      run: |
        ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
          cd ~/my_education_project &&
          git pull origin homework/cicd-deploy &&
          docker-compose down &&
          docker-compose up -d --build
        "

    - name: Deploy success notification
      if: success()
      run: echo "✅ Деплой успешно выполнен!"

    - name: Deploy failure notification
      if: failure()
      run: echo "❌ Деплой не удался!"
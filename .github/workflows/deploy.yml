name: CI/CD Pipeline

on:
  push:
    branches: [ "homework/cicd-deploy" ]

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run tests
        run: |
          echo "ğŸ§ª Running tests..."
          # Ğ—Ğ´ĞµÑÑŒ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ±Ñ‹Ñ‚ÑŒ Ğ²Ğ°ÑˆĞ¸ Ñ‚ĞµÑÑ‚Ñ‹
          echo "âœ… All tests passed!"

  deploy:
    needs: tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/homework/cicd-deploy'

    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          echo "ğŸš€ Building Docker image..."
          docker build -t my-education-app .
          echo "âœ… Docker image built successfully!"

      - name: Clean up existing container
        run: |
          echo "ğŸ§¹ Cleaning up old container..."
          docker stop my-app || true
          docker rm my-app || true
          echo "âœ… Cleanup completed!"

      - name: Run Docker container
        run: |
          echo "ğŸš€ Starting container..."
          docker run -d -p 8000:8000 --name my-app my-education-app
          echo "âœ… Container started!"

      - name: Verify container is running
        run: |
          echo "ğŸ” Verifying container status..."
          sleep 5
          if docker ps | grep -q my-app; then
            echo "âœ… Container is running successfully!"
          else
            echo "âŒ Container failed to start"
            docker logs my-app
            exit 1
          fi